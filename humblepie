#!/usr/bin/env bash
# vim: ft=sh sw=2 sts=2 et
#######################################################################
### v0.4.3
### Copyright (c) 2012 Josh McGee
###
### Permission is hereby granted, free of charge, to any person 
### obtaining a copy of this software and associated documentation
### files (the "Software"), to deal in the Software without 
### restriction, including without limitation the rights to use, copy,
### modify, merge, publish, distribute, sublicense, and/or sell copies
### of the Software, and to permit persons to whom the Software is
### furnished to do so, subject to the following conditions:
###
### The above copyright notice and this permission notice shall be 
### included in all copies or substantial portions of the Software.
###
### THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
### EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES 
### OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND 
### NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
### BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
### ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN 
### CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
### SOFTWARE.
###
#######################################################################

## comments starting with a single octothorpe are experimental code
## more than one octothorpe signifies detail or instructional comments
## all lines are 72cols or less, except printf statements

set -e
shopt -s extglob
version="v0.4.3"

messaging() {
  if (( verbose > 0 )); then
    verbose() {
      ## ERROR: return 1; else return 0
      printf "==> %s\n" "$1" "${@:2}"
      [[ "$1" == "ERROR:" ]] && ret="1"
    } >&2
    broken() { true; } &>/dev/null
  else
    broken() {
      ## broken() always returns 1 because we _probably_ want to exit
      printf "==> %s\n" "Something is wrong..." \
        "Try again with -v." "PROBLEM:" "$1" "${@:2}"
      ret=1
    } >&2
    verbose() { true; } &>/dev/null
  fi
}

check_root() {
  if (( EUID != 0 )); then
    return
  else
    verbose="1"
    messaging
    dir_rc="/etc/humblepie"
    (( asroot > 0 )) || verbose "ERROR" "Running as root requires -r!"
  fi
}

write_default_rc () {
  printf -- '# hibkey_1="foobar"\n'
  printf -- '# hibkey_2="foobar"\n'
  printf -- '# hibkey_3="foobar"\n'
  printf -- '# hibkey_4="foobar"\n'
  printf -- '# hibkey_5="foobar"\n'
  printf -- '# hibkey_android1="foobar"\n'
  printf -- '# hibkey_android2="foobar"\n'
  printf -- '# hibkey_botanicula="foobar"\n'
  printf -- '# hibkey_frozenbyte="foobar"\n'
  printf -- '# hibkey_frozensynapse="foobar"\n'
  printf -- '# hibkey_introversion="foobar"\n'
  printf -- '# hibkey_mojang="foobar"\n'
  printf -- '# hibkey_voxatron="foobar"\n'
  printf -- '\n'
  printf -- '# dir_hib="${HOME}/humbleindiebundle"\n'
  printf -- '## set these to 1 to enable\n'
  printf -- '## check md5sum of downloads\n'
  printf -- 'check_md5=1\n'
  printf -- '## spit out more detailed info, warnings, and errors\n'
  printf -- 'verbose=0\n'
} >"$rcfile"

check_dir() {
  messaging
  [[ "$dir_rc" ]] || dir_rc="${HOME}/.config/humblepie"
  dir_rc="${dir_rc%/}"
  rcfile="${dir_rc}/humblepie.rc"
  if [[ -f "$rcfile" ]]; then
    . "$rcfile"
  else
    echo "No config found, writing..."
    write_default_rc
    exit 1
  fi

  if [[ "$dir_hib" && ! -d "$dir_hib" ]]; then
    mkdir -p "$dir_hib"
  elif [[ -z "$dir_hib" ]]; then
    broken "No download directory."
    verbose "ERROR" "Specify a download directory in $rcfile," \
      "or with -d <dir>."
  fi

  (( ret != 1 ))

  for dir in "${!dir_@}"; do
    case "$dir" in
      dir_hib)
        dir_hib="${dir_hib%/}"
        [[ -d "${dir_hib}" && -w "${dir_hib}" ]] || {
          dir_hib="${HOME}/humbleindiebundle"
          verbose "INFO:" "Using $dir_hib instead..."
          mkdir -p $dir_hib
        }
       ;;
      dir_hib_torrent)
        dir_hib_torrent="${dir_hib_torrent%/}"
        [[ -d "${dir_hib_torrent}" && -w "${dir_hib_torrent}" ]] || {
          dir_hib_torrent="${HOME}/humbleindiebundle/torrents"
          verbose "INFO:" "Using $dir_hib_torrent instead..."
          mkdir -p $dir_hib_torrent
        }
       ;;
    esac
  done
}

## kudos to Riviera on #bash for help with this one o/
generate_list() {
  unset IFS links list link dl
  local game; declare -Ag links dest; declare -ag list

  if [[ "${exclude[@]}" ]]; then
    exclude_list() {
      in_array "$1" "$2"
    }
  else
    exclude_list() {
      false
    }
  fi

  if [[ "${search[@]}" ]]; then
    search_list() {
      in_array "$1" "$2"
    }
  else
    search_list() {
      :
    }
  fi
  while read -r _ link; do
    if [[ "$link" == *@(www.|files.)* ]]; then
      exclude_list "${link,,}" "${exclude[@],,}" && continue || true
      search_list  "${link,,}" "${search[@],,}" || continue
      list+=("$link")
    fi
  done < <(links -html-numbered-links 1 -dump \
            "https://www.humblebundle.com/downloads?key=${hib_key}")

  if [[ -z "${list[@]}" ]]; then
    broken "Failed to find any valid downloads."
    verbose "ERROR:" "No downloads could be found." \
      "Verify that a valid key was specified with -k," \
      "or properly configured in $rcfile."
  fi
  (( ret != 1 ))

  for dl in "${list[@]}"; do
    if [[ "$dl" == *files\.* ]]; then
      file="${dl#*files*/}"
      file="${file%%\?*}"
      links["$file"]="$dl"
    fi
  done

}

in_array() {
  local i
  for i in "${@:2}"; do
    [[ "$1" == *$i* ]] && return 0
  done
  return 1
}

# search_list() {
#   unset dl slist slinks; declare -ag slist; declare -Ag slinks
#   for s in "${!links[@]}"; do
#     [[ "${s,,}" == +(*${search,,})* ]] && slist+=("$s")
#   done

#   if [[ -z "${slist[@]}" ]]; then
#     broken "No files matched the search."
#     verbose "ERROR:" "The search was unsuccessful." \
#       "Please verify you specified a key or bundle and" \
#       "spelled the search term correctly."
#   fi
#   (( ret != 1 ))

#   for dl in "${slist[@]}"; do
#     slinks["$dl"]="${links[$dl]}"
#   done
# }

user_list() {
  unset downloads; declare -Ag dest; declare -ag downloads
  PS3="Select files by number, continue with 0: "

  select choice in "${!links[@]}"; do
    [[ "$choice" ]] || break
    downloads+=("$choice")
    dest[$choice]="${dir_hib}/${downloads[@]:(-1)}"
  done
  if [[ -z "${downloads[@]}" ]]; then
    verbose "WARNING:" "No download specified."
    exit
  fi
}

auto_dl_game () {

  case "$1" in
    single) ## array abuse so i can reuse the existing ones
      downloads[0]="$hib_game"
      dest["$hib_game"]="${dir_hib}/$hib_game"
    ;;
    *) ## present the entire list
      user_list
    ;;
  esac

  for fn in "${downloads[@]}"; do
    if [[ -f "${dest[$fn]}" ]]; then
      verbose "WARNING:" "$fn already exists! Skipping..."
    else
      verbose "INFO:" "Downloading $fn..."
      curl -# -o "${dest[$fn]}" "${links[$fn]}" &&
        verbose "INFO:" "Finished downloading ${fn}!"
    fi
  done

  (( check_md5 == 0 )) || check_sum
}

check_sum() {
  unset md5 sums dl; local md5; declare -a sums

  for dl in "${list[@]}"; do
    if [[ "$dl" == *downloads*#* ]]; then
      cksum="${dl#*#}"
      [[ "$cksum" ]] && sums+=("$cksum")
    fi
  done

  for file in "${downloads[@]}"; do
    md5="$(md5sum <"${dir_hib}/$file")"
    md5="${md5%% *}"
    for sum in "${sums[@]}"; do
      [[ "${md5^^}" == "${sum^^}" ]] && {
        success="1"
        verbose "INFO:" "The md5 for ${dir_hib}/$file is okay!"
        break
      }
    done
    if (( success < 1 )); then
      broken "Checksums did not match."
      verbose "WARNING:" "The md5 for ${dir_hib}/$file ($md5) did not check out!"
    fi
  done
}

usage() {
  printf "humblepie %s\n\n" "$version"
  printf "Configuration file: ~/.config/humblepie/humblepie.rc\n"
  printf -- "Usage: %s [options]\n\n" "${0##*/}"
  printf -- "Options:\n"
  printf -- " -b <name>   Choose the bundle specified in config\n"
  printf -- " -C <path>   Specify an alternate config file\n"
  printf -- " -d <dir>    Set the download directory\n"
  printf -- " -f <file>   Specify a file to download: must be full filename\n"
  printf -- " -k <key>    Specify a key manually: overrides -b\n"
  printf -- " -s <term>   Case-insensitive search for files in bundle: requires -b or -k, overrides -g\n"
  printf -- " -c          Enable md5 checking\n"
  printf -- " -h          Print this help\n"
  printf -- " -r          Enable operation as root, for system-wide installations *NOT RECOMMENDED*\n"
  printf -- " -w          Write out a default config and exit\n"
  printf -- " -v          Turn on verbose reporting for info, warnings, errors\n\n"
  printf -- "     EXAMPLES:\n\n"
  printf -- "     Using hibkey_5, set download directory to ${HOME}/hib and search for \`psycho':\n"
  printf -- "     %s -b 5 -d ${HOME}/hib -s psycho\n\n" "${0##*/}"
  printf -- "     Using bundle key 0a1b2c3d, download amnesia_tdd-1.2.1-3.sh without prompting:\n"
  printf -- "     %s -k 0a1b2c3d -g amnesia_tdd-1.2.1-3.sh\n\n" "${0##*/}"
}

run() {
    OPTIND=1
    while getopts ":b:C:d:e:f:k:s:chrwv" opt; do
      case "$opt" in
        \?) ## usage, exit with error
          echo "Invalid option specified." >&2
          usage
          return 1
        ;;
        h) ## print usage
          usage
          exit
        ;;
        v) ## enable verbosity
          verbose=1
        ;;
        w) ## write a config and exit
          check_dir
        ;;
        r) ## turn on root, for systemwide installs
          asroot=1
        ;;
        C) ## set location to config file
          unset rcfile
          rcfile="$OPTARG"
          . "$rcfile"
        ;;
        d) ## set the download dir
          unset dir_hib
          dir_hib="${OPTARG}"
        ;;
        b) ## just pick the bundle with the rcfile
          unset hib_key
          check_dir
          hib_key="hibkey_$OPTARG"
          hib_key="${!hib_key}"
        ;;
        k) ## specify a key manually
          unset hib_key
          hib_key="$OPTARG"
        ;;
        f) ## pick a game to download
          unset dl_arg hib_game
          dl_arg="single"
          hib_game="$OPTARG"
        ;;
        s) ## case insensitive searching
          unset hib_game
          dl_arg="search"
          search+=("$OPTARG")
        ;;
        e) ## exclusion from search
          exclude+=("$OPTARG")
        ;;
        c) ## check_game should verify md5
          check_md5=1
        ;;
      esac
    done

    messaging
    check_root
    check_dir
    generate_list
    [[ "$search" ]] && search_list
    auto_dl_game "$dl_arg"
}

if [[ -z "$@" ]]; then
  usage && exit 1
fi
run "$@"
